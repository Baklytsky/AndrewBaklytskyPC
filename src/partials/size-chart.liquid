{%- comment -%}
  Size chart

  Inherited variables:
    - product: {Object} Product object.
    - section: {Object} the current Section this code block belongs to.
  Returns variables:
    - specific_pages_arr: {Array} Page handles array from product tags
    - info_page: {Object} Page object || blank
    - show_size_guide: {Boolean}
    - size_chart_button_as_label: {Boolean}
    - size_chart_button: {String} captured markup of a button that opens the size chart drawer
    - size_chart_drawer: {String} captured markup of the size chart drawer
{%- endcomment -%}

{%- liquid
  assign show_size_guide = false
  assign size_guide_string = 'general.size_chart.button' | t
  assign info_page_title_override = settings.info_page_title_override

  capture size_chart_button_text
    if info_page_title_override != blank
      echo info_page_title_override
    else
      echo size_guide_string
    endif
  endcapture

  assign tags_string = product.tags | join: ','
  assign size_separator = '_size_'
  assign specific_pages = ''
  if tags_string contains size_separator
    for tag in product.tags
      if tag contains size_separator
        assign page_handle = tag | split: size_separator | last | split: ',' | first
        assign specific_pages = specific_pages | append: page_handle | append: ','
      endif
    endfor
  endif
  assign specific_pages_arr = specific_pages | split: ','
  if specific_pages_arr.size > 0
    assign show_size_guide = true
  endif

  assign product_size_chart = product.metafields.theme.size_chart.value
  assign info_page = settings.info_page
  if product_size_chart != blank or info_page != blank
    if product_size_chart != blank
      assign info_page = product_size_chart
    elsif info_page != blank
      assign info_page = pages[info_page]
    endif

    assign show_size_guide = true
  endif

  assign size_chart_button_as_label = false
  assign has_size_option = false
  unless product.has_only_default_variant
    for option in product.options_with_values
      assign separator = option.name | handle | prepend: ',' | append: ','
      assign size_translation = 'general.size_chart.size' | t
      assign translation_string = size_translation | remove: '  ' | replace: ', ', ',' | replace: ' ,', ',' | replace: ',', '____' | handle | replace: '____', ',' | append: ',' | prepend: ','

      unless translation_string contains separator
        continue
      endunless

      assign has_size_option = true
    endfor
  endunless

  if has_size_option and show_labels
    assign size_chart_button_as_label = true
  endif
-%}

{%- if show_size_guide -%}
  {%- liquid
    assign empty_size_guide = true

    capture drawer_classes
      echo 'popup-chart drawer drawer--right'
      if section_type == 'quickview'
        echo ' popup-chart--quickview'
      else
        echo ' cv-h'
      endif
    endcapture

    capture drawer_close_icon
      if section_type == 'quickview'
        render 'icon-chevron-right'
      else
        render 'icon-close'
      endif
    endcapture

    assign show_tabs_nav = false
    assign tabs_navigation = ''
    assign tabs = ''
    assign has_current = false
    assign index = 0
    assign pages_count = 0
  -%}

  {%- for page_handle in specific_pages_arr -%}
    {%- assign page_size_chart = pages[page_handle] -%}

    {%- if page_size_chart.title != blank -%}
      {%- capture tabs_navigation -%}
        {{ tabs_navigation }}
        <li class="tabs__link" data-tabs-link="{{ forloop.index0 }}" tabindex="0">{{ page_size_chart.title }}</li>
      {%- endcapture -%}

      {%- capture tabs -%}
        {{ tabs }}
        <div class="tab{% unless has_current %} current{% endunless %}" data-tab="{{ forloop.index0 }}">
          {%- if page_size_chart.content != blank -%}
            {{ page_size_chart.content }}
          {%- else -%}
            {{ 'homepage.onboarding.no_page_content' | t }}
          {%- endif -%}
        </div>
      {%- endcapture -%}

      {%- assign has_current = true -%}
      {%- assign pages_count = pages_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if info_page != blank -%}
    {%- assign index = specific_pages_arr.size -%}

    {%- capture tabs_navigation -%}
      {{ tabs_navigation }}
      {%- if info_page.title != blank -%}
        <li class="tabs__link" data-tabs-link="{{ index }}" data-lock-scroll tabindex="0">{{ info_page.title }}</li>
      {%- endif -%}
    {%- endcapture -%}

    {%- capture tabs -%}
      {{ tabs }}
      <div class="tab{% unless has_current %} current{% endunless %}" data-tab="{{ index }}">
        {%- if info_page.content != blank -%}
          {{ info_page.content }}
        {%- else -%}
          {{ 'homepage.onboarding.no_page_content' | t }}
        {%- endif -%}
      </div>
    {%- endcapture -%}

    {%- assign has_current = true -%}
    {%- assign pages_count = pages_count | plus: 1 -%}
  {%- endif -%}

  {%- liquid
    if tabs != blank
      assign empty_size_guide = false
    endif
    if pages_count > 1 and tabs_navigation != blank
      assign show_tabs_nav = true
    endif
  -%}

  {%- capture size_chart_drawer -%}
    {%- unless empty_size_guide -%}
      <div class="{{ drawer_classes }}" id="size-chart--{{ unique }}" aria-hidden="true" role="dialog" data-drawer>
        <button type="button" class="drawer__close-button" aria-controls="size-chart--{{ unique }}" data-drawer-toggle>
          <span class="visually-hidden">{{ 'general.accessibility.close_drawer' | t }}</span>
          {{- drawer_close_icon -}}
        </button>

        <div class="popup-chart__inner" data-scroll>
          <div class="popup-chart__content">
            <div class="rte tabs" data-tabs-holder>
              {%- if show_tabs_nav -%}
                <div class="tabs__head">
                  <div class="tabs-scrollbar" data-custom-scrollbar-parent>
                    <div class="tabs-scrollbar__holder" data-custom-scrollbar-holder>
                      <ul class="tabs__nav subheading-text" data-custom-scrollbar-items>
                        {{ tabs_navigation }}
                      </ul>

                      <div class="custom-scrollbar" data-custom-scrollbar>
                        <div class="custom-scrollbar__thumb" data-custom-scrollbar-thumb></div>
                      </div>
                    </div>
                  </div>
                </div>
              {%- endif -%}

              {%- if tabs != '' -%}
                <div class="tabs__contents" data-tabs-contents>
                  {{ tabs }}
                </div>
              {%- endif -%}
            </div>
          </div>
        </div>
      </div>
    {%- endunless -%}
  {%- endcapture -%}

  {%- capture size_chart_button -%}
    {%- unless empty_size_guide -%}
      <button type="button" class="product__popup__link label-typography" href="{{ info_page.url | default: '#!' }}" aria-controls="size-chart--{{ unique }}" data-drawer-toggle>
        {% render 'icon-ruler' %}
        <span>{{ size_chart_button_text }}</span>
      </button>
    {%- endunless -%}
  {%- endcapture -%}
{%- endif -%}